---
title: "report"
author: "Julia Chałasiak"
date: "20 11 2021"
output:
  html_document:
    toc: true
    toc_float: true
    theme: spacelab
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(readxl)
library(imputeTS)
library(vtable)
library(skimr)
library(DT)
library(caret)
library(gganimate)
```


## R Wczytywanie danych


```{r datasets_reading}
currExchRates <- read.csv("./datasets/CurrencyExchangeRates.csv")
goldPrices <- read.csv("./datasets/Gold prices.csv")
spComposite <- read.csv("./datasets/S&P Composite.csv")
worldDevInd <- read_excel("./datasets/World_Development_Indicators.xlsx", trim_ws=TRUE, na = "..")
worldDevInd <- data.frame(worldDevInd)
btcMetadata <- read.csv("./datasets/BCHAIN_metadata.csv")
btcDiff <- read.csv("./datasets/BCHAIN-DIFF.csv")
btcHrate <- read.csv("./datasets/BCHAIN-HRATE.csv")
btcMkpru <- read.csv("./datasets/BCHAIN-MKPRU.csv")
btcTrvou <- read.csv("./datasets/BCHAIN-TRVOU.csv")
```

## Bitcoin's data

```{r bitcoin simple}
ggplot(btcDiff, aes(x=Date, y=Value, group = 1)) + geom_line()
ggplot(btcHrate, aes(x=Date, y=Value, group = 1)) + geom_line()
ggplot(btcMkpru, aes(x=Date, y=Value, group = 1)) + geom_line()
ggplot(btcTrvou, aes(x=Date, y=Value, group = 1)) + geom_line()

```

## Preparing Currency Data

```{r tidy_currency}
CurrExchRatesClean <- currExchRates %>% select(which(colMeans(is.na(.)) < 0.2))
CurrExchRatesClean <- CurrExchRatesClean %>% mutate(Euro = ifelse(Date < as.Date("1998-10-30", format="%Y-%m-%d"), 0, Euro))
CurrExchRatesClean <- na_ma(CurrExchRatesClean, k = 1)
```

## Preparing Gold Prices Data

```{r tidy_gold}
goldPricesClean <- goldPrices %>% mutate(
  EURO..AM. = ifelse(Date < as.Date("1998-12-31", format="%Y-%m-%d"), 0, EURO..AM.),
  EURO..PM. = ifelse(Date < as.Date("1998-12-31", format="%Y-%m-%d"), 0, EURO..PM.),
  USD..PM. = ifelse(Date < as.Date("1968-03-14", format="%Y-%m-%d"), 0, USD..PM.),
  GBP..PM. = ifelse(Date < as.Date("1968-03-14", format="%Y-%m-%d"), 0, GBP..PM.))
goldPricesClean <- na_ma(goldPricesClean, k = 1)
```

## Preparing World Dev Index

```{r tidy_index}
worldDevInd$Series.Name<-gsub("\\$","D",worldDevInd$Series.Name)

worldDevIndClean <- worldDevInd %>% select(-Series.Code) %>% 
  pivot_longer('X1970..YR1970.':'X2020..YR2020.', names_to = "Year", values_to = "Value", values_drop_na = FALSE) %>%
  pivot_wider(names_from = "Series.Name", values_from = Value) %>% unchop(everything())


worldDevIndClean <- worldDevIndClean %>% 
  mutate(Year = substr(Year, 2, 5)) %>% 
  filter(grepl('', Country.Code)) %>%
  relocate(Year, .after = Country.Code)


trial <- as.data.frame(worldDevIndClean)
trial <- trial %>% select(which(colMeans(is.na(.)) < 0.2))
trial[is.na(trial)] <- 0
worldDevIndClean <- trial
```


## Preparing SP Composite
```{r tidy_sp_composite}
spCompositeClean <- spComposite %>% 
  mutate(Cyclically.Adjusted.PE.Ratio = ifelse(Year < as.Date("1880-12-31", format="%Y-%m-%d"), 0, Cyclically.Adjusted.PE.Ratio)) %>% rename(Date = Year)
spCompositeClean <- na_ma(spCompositeClean, k = 1)

```

## Preparing Bitcoin Data
```{r tidy_bitcoin}
btcTrvou <- btcTrvou %>% rename(Trvou = Value)
btcMkpru <- btcMkpru %>% rename(Mkpru = Value)
btcDiff <- btcDiff %>% rename(Diff = Value)
btcHrate <- btcHrate %>% rename(Hrate = Value)
btcAllClean <- btcTrvou %>% left_join(btcMkpru) %>% left_join(btcHrate) %>% left_join(btcDiff)
btcAllClean <- na_ma(btcAllClean, k = 1)
```
## Summary
```{r basic_summary}
st(CurrExchRatesClean)
st(goldPricesClean)
st(spComposite)
st(btcAllClean)

datatable(skim(worldDevIndClean %>% dplyr::select(-Country.Name, -Country.Code, -Year)) %>% dplyr::select(skim_variable, numeric.mean, numeric.sd, numeric.p0, numeric.p25, numeric.p75, numeric.p100))
```

## Interesting Corelations
```{r corelations}

#https://worldpopulationreview.com/country-rankings/developed-countries
hdiTop <- c('Norway', 'Ireland', 'Switzerland', 'Iceland', 'Hong Kong', 'Germany', 'Sweden', 'Netherlands', 'Australia', 'Denmark', 'Finland', 'Singapore', 'United Kingdom', 'New Zealand', 'Belgium', 'Canada', 'United States', 'Austria', 'Liechtenstein', 'Israel', 'Japan', 'Slovenia', 'Luxembourg', 'Korea, Rep.', 'Spain')

wdiTop <- worldDevIndClean %>% filter(Country.Name %in% hdiTop)
View(wdiTop)
```


## Animations in Time
```{r animations}

```



## Model
```{r model}

set.seed(23)

btcAllClean2 <- btcAllClean %>% select(-Date)

inTraining <- createDataPartition(y = btcAllClean2$Mkpru, p = .70, list = FALSE)
train <- btcAllClean2[inTraining,]
valid_and_test  <- btcAllClean2[-inTraining,]

inTesting <- createDataPartition(y = valid_and_test$Mkpru, p = .50, list = FALSE)
valid <- valid_and_test[ -inTesting,]
test <- valid_and_test[ inTesting,]


ctrl <- trainControl(
    # powtórzona ocena krzyżowa
    method = "repeatedcv",
    # liczba podziałów
    number = 2,
    # liczba powtórzeń
    repeats = 5)


fit <- train(Mkpru ~ .,
             data = train,
             method = "rf",
             trControl = ctrl,
             # Paramter dla algorytmu uczącego
             ntree = 10)

fit

pred <- predict(fit, newdata = test)
preddf <- data.frame(Pred = pred, Mkpru = test$Mkpru)

View(preddf)
```






